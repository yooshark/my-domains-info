from typing import Any, Self, TypeVar

from sqlalchemy.ext.asyncio import (
    AsyncSession,
    AsyncSessionTransaction,
    async_sessionmaker,
)

from app.db.repositories.domain_info import DomainInfoRepository

TExc = TypeVar("TExc", bound=BaseException)


class SaSessionUnitOfWork:
    session: AsyncSession
    session_factory: async_sessionmaker[AsyncSession]
    transaction: AsyncSessionTransaction
    domain_info: DomainInfoRepository

    def __init__(self, session_factory: async_sessionmaker[AsyncSession]) -> None:
        self.session_factory = session_factory

    async def __aenter__(self) -> Self:
        self.session = self.session_factory()
        self.domain_info = DomainInfoRepository(self.session)
        self.transaction: AsyncSessionTransaction = await self.session.begin()
        return self

    async def __aexit__(
        self, exc_type: type[TExc] | None, exc: TExc | None, traceback: Any | None
    ) -> None:
        if exc_type is None:
            await self.commit()
        else:
            await self.transaction.rollback()
        await self.session.close()

    async def commit(self) -> None:
        await self.transaction.commit()
